(function(){return function(n){return typeof define=="function"&&define.amd?define("knockback",["underscore","backbone","knockout"],n):n.call(this)}(function(){var d,g,nt,tt,l,s,a,h,c,it,rt,k,v,y,p,w,ht,n,i,ut,t,o,ft,et,ct,e,u,b,r,f,ot=function(n,t){return function(){return n.apply(t,arguments)}};if(n=function(){function n(){}return n.VERSION="0.17.2",n.TYPE_UNKNOWN=0,n.TYPE_SIMPLE=1,n.TYPE_ARRAY=2,n.TYPE_MODEL=3,n.TYPE_COLLECTION=4,n.wasReleased=function(n){return!n||n.__kb_released},n.isReleaseable=function(t,r){var u,f;if(r==null&&(r=0),!t||t!==Object(t)||t.__kb_released)return!1;if(i.isObservable(t)||t instanceof n.ViewModel)return!0;if(typeof t=="function"||t instanceof n.Model||t instanceof n.Collection)return!1;if(typeof t.dispose=="function"||typeof t.destroy=="function"||typeof t.release=="function")return!0;if(r<1)for(u in t)if(f=t[u],u!=="__kb"&&n.isReleaseable(f,r+1))return!0;return!1},n.release=function(r){var e,u,f;if(n.isReleaseable(r)){if(t.isArray(r)){for(u in r)f=r[u],n.isReleaseable(f)&&(r[u]=null,n.release(f));return}if(r.__kb_released=!0,i.isObservable(r)&&t.isArray(e=r())){if(r.__kb_is_co||r.__kb_is_o&&r.valueType()===s)r.destroy?r.destroy():r.dispose&&r.dispose();else if(e.length)for(u in e)f=e[u],n.isReleaseable(f)&&(e[u]=null,n.release(f))}else typeof r.release=="function"?r.release():typeof r.destroy=="function"?r.destroy():typeof r.dispose=="function"?r.dispose():i.isObservable(r)||this.releaseKeys(r)}},n.releaseKeys=function(t){var i,r;for(i in t)r=t[i],i!=="__kb"&&n.isReleaseable(r)&&(t[i]=null,n.release(r))},n.releaseOnNodeRemove=function(t,r){return t||u(this,"missing view model"),r||u(this,"missing node"),i.utils.domNodeDisposal.addDisposeCallback(r,function(){return n.release(t)})},n.renderTemplate=function(t,r,u){var f,e;return u==null&&(u={}),f=document.createElement("div"),e=i.renderTemplate(t,r,u,f,"replaceChildren"),f.children.length===1&&(f=f.children[0]),n.releaseOnNodeRemove(r,f),e.dispose(),r.afterRender&&!u.afterRender&&r.afterRender(f),f},n.applyBindings=function(t,r){return i.applyBindings(t,r),n.releaseOnNodeRemove(t,r)},n}(),this.Knockback=this.kb=n,typeof exports!="undefined"&&(module.exports=n),this.Parse)n._=t=this.Parse._,n.Parse=this.Parse,n.Collection=this.Parse.Collection,n.Model=this.Parse.Object,n.Events=this.Parse.Events;else{if(this._||typeof require=="undefined")t=this._;else try{t=require("lodash")}catch(lt){ht=lt,t=require("underscore")}n._=t=t.hasOwnProperty("_")?t._:t,t.where&&!t.findWhere&&t.mixin({findWhere:function(n,i){var r;return r=t.where(n,i),r.length?r[0]:null}}),n.Backbone=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,n.Collection=n.Backbone.Collection,n.Model=n.Backbone.Model,n.Events=n.Backbone.Events}n.ko=i=!this.ko&&typeof require!="undefined"?require("knockout"):this.ko,e=function(n,i){throw""+(t.isString(n)?n:n.constructor.name)+": "+i+" is missing";},u=function(n,i){throw""+(t.isString(n)?n:n.constructor.name)+": "+i+" is unexpected";},ct=function(n,t,i){var r;return this._legacy_warnings||(this._legacy_warnings={}),(r=this._legacy_warnings)[n]||(r[n]=0),this._legacy_warnings[n]++,console.warn("warning: '"+n+"' has been deprecated (will be removed in Knockback after "+t+"). "+i+".")},ft=Array.prototype.splice,r=i.utils.unwrapObservable,p=function(n){for(var i=t.clone(n);n.options;)t.defaults(i,n.options),n=n.options;return delete i.options,i},w=function(n,t){var i,r;for(i in t)r=t[i],n[i]=r;return n};var st=function(){},at=function(n,t,i){var r;return r=t&&t.hasOwnProperty("constructor")?t.constructor:function(){n.apply(this,arguments)},w(r,n),st.prototype=n.prototype,r.prototype=new st,t&&w(r.prototype,t),i&&w(r,i),r.prototype.constructor=r,r.__super__=n.prototype,r},vt=function(n,t){var i=at(this,n,t);return i.extend=this.extend,i};return n.extend=vt,c=n.TYPE_UNKNOWN,h=n.TYPE_SIMPLE,l=n.TYPE_ARRAY,a=n.TYPE_MODEL,s=n.TYPE_COLLECTION,f=function(n,t,i){return arguments.length===2?n&&n.__kb&&n.__kb.hasOwnProperty(t)?n.__kb[t]:void 0:(n||u(this,"no obj for wrapping "+t),n.__kb||(n.__kb={}),n.__kb[t]=i,i)},o=function(n,t){return ft.call(n,1,0,t),n},b=function(n){var i,r,u;if(!n)return n;if(n.__kb)return"object"in n.__kb?n.__kb.object:n;if(t.isArray(n))return t.map(n,function(n){return b(n)});if(t.isObject(n)&&n.constructor==={}.constructor){r={};for(i in n)u=n[i],r[i]=b(u);return r}return n},n.utils=function(){function u(){}return u.wrappedObservable=function(){return f.apply(this,o(arguments,"observable"))},u.wrappedObject=function(){return f.apply(this,o(arguments,"object"))},u.wrappedModel=function(n,i){return arguments.length===1?(i=f(n,"object"),t.isUndefined(i)?n:i):f(n,"object",i)},u.wrappedStore=function(){return f.apply(this,o(arguments,"store"))},u.wrappedStoreIsOwned=function(){return f.apply(this,o(arguments,"store_is_owned"))},u.wrappedFactory=function(){return f.apply(this,o(arguments,"factory"))},u.wrappedEventWatcher=function(){return f.apply(this,o(arguments,"event_watcher"))},u.wrappedEventWatcherIsOwned=function(){return f.apply(this,o(arguments,"event_watcher_is_owned"))},u.wrappedDestroy=function(n){var t;if(n.__kb)return n.__kb.event_watcher&&n.__kb.event_watcher.releaseCallbacks(n),t=n.__kb,n.__kb=null,t.observable&&(t.observable.destroy=t.observable.release=null,this.wrappedDestroy(t.observable),t.observable=null),t.factory=null,t.event_watcher_is_owned&&t.event_watcher.destroy(),t.event_watcher=null,t.store_is_owned&&t.store.destroy(),t.store=null},u.valueType=function(i){return i?i.__kb_is_o?i.valueType():i.__kb_is_co||i instanceof n.Collection?s:i instanceof n.ViewModel||i instanceof n.Model?a:t.isArray(i)?l:h:c},u.pathJoin=function(n,t){return(n?n[n.length-1]!=="."?""+n+".":n:"")+t},u.optionsPathJoin=function(n,i){return t.defaults({path:this.pathJoin(n.path,i)},n)},u.inferCreator=function(i,u,f,e,o){var h,s;return(u&&(h=u.creatorForPath(i,f)),h)?h:e&&n.Backbone&&n.Backbone.RelationalModel&&e instanceof n.Backbone.RelationalModel&&(o=r(o),s=t.find(e.getRelations(),function(n){return n.key===o}),s)?s.collectionType||t.isArray(s.keyContents)?n.CollectionObservable:n.ViewModel:i?i instanceof n.Model?n.ViewModel:i instanceof n.Collection?n.CollectionObservable:null:null},u.createFromDefaultCreator=function(r,u){return r instanceof n.Model?n.viewModel(r,u):r instanceof n.Collection?n.collectionObservable(r,u):t.isArray(r)?i.observableArray(r):i.observable(r)},u.hasModelSignature=function(n){return n&&n.attributes&&!n.models&&typeof n.get=="function"&&typeof n.trigger=="function"},u.hasCollectionSignature=function(n){return n&&n.models&&typeof n.get=="function"&&typeof n.trigger=="function"},u}(),n.Factory=function(){function t(n){this.parent_factory=n,this.paths={}}return t.useOptionsOrCreate=function(t,i,r){var u;return t.factory&&(!t.factories||t.factories&&t.factory.hasPathMappings(t.factories,r))?n.utils.wrappedFactory(i,t.factory):(u=n.utils.wrappedFactory(i,new n.Factory(t.factory)),t.factories&&u.addPathMappings(t.factories,r),u)},t.prototype.hasPath=function(n){return this.paths.hasOwnProperty(n)||this.parent_factory&&this.parent_factory.hasPath(n)},t.prototype.addPathMapping=function(n,t){return this.paths[n]=t},t.prototype.addPathMappings=function(t,i){var u,r;for(r in t)u=t[r],this.paths[n.utils.pathJoin(i,r)]=u},t.prototype.hasPathMappings=function(t,i){var r,f,e,u;r=!0;for(u in t)f=t[u],r&=(e=this.creatorForPath(null,n.utils.pathJoin(i,u)))&&f===e;return r},t.prototype.creatorForPath=function(n,t){var i;return(i=this.paths[t])?i.view_model?i.view_model:i:this.parent_factory&&(i=this.parent_factory.creatorForPath(n,t))?i:null},t}(),n.Store=function(){function t(){this.observable_records=[],this.replaced_observables=[]}return t.useOptionsOrCreate=function(t,i,r){return t.store?(t.store.register(i,r,t),n.utils.wrappedStore(r,t.store)):(n.utils.wrappedStoreIsOwned(r,!0),n.utils.wrappedStore(r,new n.Store))},t.prototype.destroy=function(){return this.clear()},t.prototype.clear=function(){var r,t,u,i;for(i=this.observable_records.splice(0,this.observable_records.length),t=0,u=i.length;t<u;t++)r=i[t],n.release(r.observable);n.release(this.replaced_observables)},t.prototype.register=function(t,r,u){var f;if(r)return i.isObservable(r)||r.__kb_is_co?void 0:(n.utils.wrappedObject(r,t),t||(r.__kb_null=!0),f=u.creator?u.creator:u.path&&u.factory?u.factory.creatorForPath(t,u.path):null,f||(f=r.constructor),this.observable_records.push({obj:t,observable:r,creator:f}),r)},t.prototype.findIndex=function(t,i){var u,r,f;if(!t||t instanceof n.Model){f=this.observable_records;for(u in f)if(r=f[u],r.observable){if(r.observable.__kb_released){r.obj=null,r.observable=null;continue}if(!t&&!r.observable.__kb_null||t&&(r.observable.__kb_null||r.obj!==t))continue;else if(r.creator===i||r.creator.create&&r.creator.create===i.create)return u}}return-1},t.prototype.find=function(n,t){var i;return(i=this.findIndex(n,t))<0?null:this.observable_records[i].observable},t.prototype.isRegistered=function(n){var r,t,u,i;for(i=this.observable_records,t=0,u=i.length;t<u;t++)if(r=i[t],r.observable===n)return!0;return!1},t.prototype.findOrCreate=function(t,r){var f,u;if(r.store=this,r.creator||(r.creator=n.utils.inferCreator(t,r.factory,r.path)),!r.creator&&t instanceof n.Model&&(r.creator=kv.ViewModel),f=r.creator,f){if(f.models_only)return t}else return n.utils.createFromDefaultCreator(t,r);return(f&&(u=this.find(t,f)),u)?u:(u=f.create?f.create(t,r):new f(t,r),u||(u=i.observable(null)),i.isObservable(u)||this.isRegistered(u)||this.register(t,u,r),u)},t.prototype.findOrReplace=function(t,i,r){var e,f;return t||u(this,"obj missing"),(e=this.findIndex(t,i))<0?this.register(t,r,{creator:i}):(f=this.observable_records[e],n.utils.wrappedObject(f.observable)===t||u(this,"different object"),f.observable!==r&&(f.observable.constructor===r.constructor||u(this,"replacing different type"),this.replaced_observables.push(f.observable),f.observable=r),r)},t}(),k=function(t,i,r){return!n.statistics||n.statistics.addModelEvent({name:i,emitter:t,key:r.key,path:r.path})},n.EventWatcher=function(){function i(n,i,r){this._onModelUnloaded=ot(this._onModelUnloaded,this),this._onModelLoaded=ot(this._onModelLoaded,this),this.__kb||(this.__kb={}),this.__kb.callbacks={},this.__kb._onModelLoaded=t.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=t.bind(this._onModelUnloaded,this),r&&this.registerCallbacks(i,r),n?this.emitter(n):this.ee=null}return i.useOptionsOrCreate=function(t,i,r,f){return t.event_watcher?(t.event_watcher.emitter()===i||t.event_watcher.model_ref===i||u(this,"emitter not matching"),n.utils.wrappedEventWatcher(r,t.event_watcher).registerCallbacks(r,f)):(n.utils.wrappedEventWatcherIsOwned(r,!0),n.utils.wrappedEventWatcher(r,new n.EventWatcher(i)).registerCallbacks(r,f))},i.prototype.destroy=function(){return this.emitter(null),this.__kb.callbacks=null,n.utils.wrappedDestroy(this)},i.prototype.emitter=function(t){var i,r,f,e,o,u,h,s;if(arguments.length===0||this.ee===t)return this.ee;this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),n.Backbone&&n.Backbone.ModelRef&&t instanceof n.Backbone.ModelRef?(this.model_ref=t,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),t=this.model_ref.model()):delete this.model_ref,o=this.ee,this.ee=t,s=this.__kb.callbacks;for(r in s)for(i=s[r],o&&o.unbind(r,i.fn),t&&this.ee.bind(r,i.fn),e=i.list,u=0,h=e.length;u<h;u++)f=e[u],f.emitter&&f.emitter(this.ee);return t},i.prototype.registerCallbacks=function(i,u){var f,o,h,a,s,c,l,v,y=this;for(i||e(this,"obj"),u||e(this,"info"),a=u.event_selector?u.event_selector:"change",h=a.split(" "),l=0,v=h.length;l<v;l++)(o=h[l],o)&&(f=this.__kb.callbacks[o],f||(c=[],f={list:c,fn:function(t){for(var i,u=0,f=c.length;u<f;u++)if(i=c[u],i.update&&!i.rel_fn){if(t&&i.key&&t.hasChanged&&!t.hasChanged(r(i.key)))continue;n.statistics&&k(t,o,i),i.update()}return null}},this.__kb.callbacks[o]=f,this.ee&&this.ee.bind(o,f.fn)),s=t.defaults({obj:i},u),f.list.push(s));this.ee&&(n.Backbone&&n.Backbone.RelationalModel&&this.ee instanceof n.Backbone.RelationalModel&&t.contains(h,"change")&&this._modelBindRelatationalInfo("change",s),s.emitter(this.ee)&&s.emitter)},i.prototype.releaseCallbacks=function(t){var r,u,f,i,e,o;if(this.__kb.callbacks&&this.ee){e=this.__kb.callbacks;for(u in e){r=e[u],o=r.list;for(f in o)if(i=o[f],i.obj===t){r.list.splice(f,1),i.rel_fn&&this._modelUnbindRelatationalInfo(u,i),!n.wasReleased(t)&&i.emitter&&i.emitter(null);return}}}},i.prototype._onModelLoaded=function(t){var f,i,r,s,e,u,h,o;s=n.Backbone&&n.Backbone.RelationalModel&&t instanceof n.Backbone.RelationalModel,this.ee=t,o=this.__kb.callbacks;for(i in o)for(f=o[i],this.ee.bind(i,f.fn),e=f.list,u=0,h=e.length;u<h;u++)r=e[u],s&&this._modelBindRelatationalInfo(i,r),r.emitter&&r.emitter(this.ee)},i.prototype._onModelUnloaded=function(n){var u,i,t,f,r,o,e;this.ee=null,e=this.__kb.callbacks;for(i in e)for(u=e[i],n.unbind(i,u.fn),f=u.list,r=0,o=f.length;r<o;r++)t=f[r],t.rel_fn&&this._modelUnbindRelatationalInfo(i,t),t.emitter&&t.emitter(null)},i.prototype._modelBindRelatationalInfo=function(i,u){var e,f;if(i==="change"&&u.key&&u.update){if(e=r(u.key),f=t.find(this.ee.getRelations(),function(n){return n.key===e}),!f)return;u.rel_fn=function(t){return n.statistics&&k(t,""+i+" (relational)",u),u.update()},f.collectionType||t.isArray(f.keyContents)?(u.is_collection=!0,this.ee.bind("add:"+u.key,u.rel_fn),this.ee.bind("remove:"+u.key,u.rel_fn)):this.ee.bind(Backbone.Relation.prototype.sanitizeOptions?"update:"+u.key:"change:"+u.key,u.rel_fn)}},i.prototype._modelUnbindRelatationalInfo=function(n,t){t.rel_fn&&(t.is_collection?(this.ee.unbind("add:"+t.key,t.rel_fn),this.ee.unbind("remove:"+t.key,t.rel_fn)):this.ee.unbind(Backbone.Relation.prototype.sanitizeOptions?"update:"+t.key:"change:"+t.key,t.rel_fn),t.rel_fn=null)},i}(),n.emitterObservable=function(t,i){return new n.EventWatcher(t,i)},n.Observable=function(){function u(u,f,o){var s,l,c,h=this;return this.vm=o,f||e(this,"options"),this.vm||(this.vm={}),s=t.isString(f)||i.isObservable(f)?this.create_options={key:f}:this.create_options=p(f),this.key=s.key,delete s.key,this.key||e(this,"key"),s.args&&(this.args=s.args,delete s.args),s.read&&(this.read=s.read,delete s.read),s.write&&(this.write=s.write,delete s.write),l=s.event_watcher,delete s.event_watcher,this.vo=i.observable(null),this._model=i.observable(),c=n.utils.wrappedObservable(this,i.dependentObservable({read:function(){var f,n,e,i,o,u;if(n=[r(h.key)],h.args)if(t.isArray(h.args))for(u=h.args,i=0,o=u.length;i<o;i++)f=u[i],n.push(r(f));else n.push(r(h.args));return h._mdl===h._model()&&h._mdl&&(e=h.read?h.read.apply(h.vm,n):h._mdl.get.apply(h._mdl,n),h.update(e)),r(h.vo())},write:function(n){var s,i,f,e,u,c,o;if(e=b(n),f={},f[r(h.key)]=e,i=h.write?[e]:[f],h.args)if(t.isArray(h.args))for(o=h.args,u=0,c=o.length;u<c;u++)s=o[u],i.push(r(s));else i.push(r(h.args));return h._mdl&&(h.write?h.write.apply(h.vm,i):h._mdl.set.apply(h._mdl,i)),h.update(n)},owner:this.vm})),c.__kb_is_o=!0,s.store=n.utils.wrappedStore(c,s.store),s.path=n.utils.pathJoin(s.path,this.key),s.factories&&(typeof s.factories=="function"||s.factories.create)?(s.factory=n.utils.wrappedFactory(c,new n.Factory(s.factory)),s.factory.addPathMapping(s.path,s.factories)):s.factory=n.Factory.useOptionsOrCreate(s,c,s.path),delete s.factories,c.value=t.bind(this.value,this),c.valueType=t.bind(this.valueType,this),c.destroy=t.bind(this.destroy,this),c.model=this.model=i.dependentObservable({read:function(){return h._model(),h._mdl},write:function(n){if(!h.__kb_released&&h._mdl!==n)return h._mdl=n,h.update(null),h._model(n)}}),n.EventWatcher.useOptionsOrCreate({event_watcher:l},u,this,{emitter:this.model,update:t.bind(this.update,this),key:this.key,path:s.path}),this.__kb_value||this.update(),n.LocalizedObservable&&s.localizer&&(c=new s.localizer(c),delete s.localizer),n.DefaultObservable&&s.hasOwnProperty("default")&&(c=n.defaultObservable(c,s["default"]),delete s["default"]),c}return u.prototype.destroy=function(){var t;return t=n.utils.wrappedObservable(this),this.__kb_released=!0,n.release(this.__kb_value),this.__kb_value=null,this.model.dispose(),this._mdl=this.model=t.model=null,n.utils.wrappedDestroy(this)},u.prototype.value=function(){return this.__kb_value},u.prototype.valueType=function(){var n;return n=this._mdl?this._mdl.get(this.key):null,this.value_type||this._updateValueObservable(n),this.value_type},u.prototype.update=function(i){var f,u;if(!this.__kb_released){if(this._mdl&&!arguments.length&&(i=this._mdl.get(r(this.key))),i!==void 0||(i=null),f=n.utils.valueType(i),(!this.__kb_value||this.__kb_value.__kb_released||this.__kb_value.__kb_null&&i)&&(this.__kb_value=void 0,this.value_type=void 0),u=this.__kb_value,t.isUndefined(this.value_type)||this.value_type!==f&&f!==c)return this.value_type===s&&f===l?u(i):this._updateValueObservable(i);if(this.value_type===a){if(typeof u.model=="function"){if(u.model()!==i)return u.model(i)}else if(n.utils.wrappedObject(u)!==i)return this._updateValueObservable(i)}else if(this.value_type===s){if(u.collection()!==i)return u.collection(i)}else if(u()!==i)return u(i)}},u.prototype._updateValueObservable=function(r){var f,e,o,u;return f=this.create_options,f.creator=n.utils.inferCreator(r,f.factory,f.path,this._mdl,this.key),this.value_type=c,e=f.creator,o=this.__kb_value,this.__kb_value=void 0,o&&n.release(o),e?f.store?u=f.store.findOrCreate(r,f):e.models_only?(u=r,this.value_type=h):u=e.create?e.create(r,f):new e(r,f):t.isArray(r)?(this.value_type=l,u=i.observableArray(r)):(this.value_type=h,u=i.observable(r)),this.value_type===c&&(i.isObservable(u)?this.value_type=u.__kb_is_co?s:h:(this.value_type=a,typeof u.model!="function"&&n.utils.wrappedObject(u,r))),this.__kb_value=u,this.vo(u)},u}(),n.observable=function(t,i,r){return new n.Observable(t,i,r)},n.ViewModel=function(){function r(r,e,o){var v,l,k,s,y,c,w,a,b,h=this;if(!r||r instanceof n.Model||typeof r.get=="function"&&typeof r.bind=="function"||u(this,"not a model"),e||(e={}),o||(o={}),e=t.isArray(e)?{keys:e}:p(e),this.__kb||(this.__kb={}),this.__kb.vm_keys={},this.__kb.model_keys={},this.__kb.view_model=t.isUndefined(o)?this:o,e.internals&&(this.__kb.internals=t.isArray(e.internals)?e.internals:[e.internals]),e.excludes&&(this.__kb.excludes=t.isArray(e.excludes)?e.excludes:[e.excludes]),n.Store.useOptionsOrCreate(e,r,this),this.__kb.path=e.path,n.Factory.useOptionsOrCreate(e,this,e.path),a=f(this,"_mdl",i.observable()),this.model=i.dependentObservable({read:function(){return a(),n.utils.wrappedObject(h)},write:function(i){var r,f;if(n.utils.wrappedObject(h)!==i){if(h.__kb_null){i&&u(h,"model set on shared null");return}if(n.utils.wrappedObject(h,i),r=n.utils.wrappedEventWatcher(h),!r){a(i);return}r.emitter(i),h.__kb.keys||!i||!i.attributes||(f=t.difference(t.keys(i.attributes),t.keys(h.__kb.model_keys)),f&&h._createObservables(i,f)),a(i)}}}),k=n.utils.wrappedEventWatcher(this,new n.EventWatcher(r,this,{emitter:this.model})),e.requires&&(s=t.isArray(e.requires)?t.clone(e.requires):[e.requires]),this.__kb.internals&&(s=s?t.union(s,this.__kb.internals):t.clone(this.__kb.internals)),e.keys)if(t.isObject(e.keys)&&!t.isArray(e.keys)){y={},b=e.keys;for(w in b)c=b[w],y[t.isString(c)?c:c.key?c.key:w]=!0;this.__kb.keys=t.keys(y)}else this.__kb.keys=t.isArray(e.keys)?e.keys:[e.keys],s=s?t.union(s,this.__kb.keys):t.clone(this.__kb.keys);else l=k.emitter(),l&&l.attributes&&(v=t.keys(l.attributes),s=s?t.union(s,v):v);s&&this.__kb.excludes&&(s=t.difference(s,this.__kb.excludes)),t.isObject(e.keys)&&!t.isArray(e.keys)&&this._mapObservables(r,e.keys),t.isObject(e.requires)&&!t.isArray(e.requires)&&this._mapObservables(r,e.requires),e.mappings&&this._mapObservables(r,e.mappings),s&&this._createObservables(r,s),n.statistics&&n.statistics.register("ViewModel",this)}return r.extend=n.extend,r.prototype.destroy=function(){var t;if(this.__kb.view_model!==this)for(t in this.__kb.vm_keys)this.__kb.view_model[t]=null;return this.__kb.view_model=null,n.releaseKeys(this),n.utils.wrappedDestroy(this),!n.statistics||n.statistics.unregister("ViewModel",this)},r.prototype.shareOptions=function(){return{store:n.utils.wrappedStore(this),factory:n.utils.wrappedFactory(this)}},r.prototype._createObservables=function(i,r){var o,u,f,e,s;for(o={store:n.utils.wrappedStore(this),factory:n.utils.wrappedFactory(this),path:this.__kb.path,event_watcher:n.utils.wrappedEventWatcher(this)},e=0,s=r.length;e<s;e++)(u=r[e],f=this.__kb.internals&&t.contains(this.__kb.internals,u)?"_"+u:u,this[f])||(this.__kb.vm_keys[f]=!0,this.__kb.model_keys[u]=!0,o.key=u,this[f]=this.__kb.view_model[f]=n.observable(i,o,this))},r.prototype._mapObservables=function(i,r){var e,u,f;e={store:n.utils.wrappedStore(this),factory:n.utils.wrappedFactory(this),path:this.__kb.path,event_watcher:n.utils.wrappedEventWatcher(this)};for(f in r)(u=r[f],this[f])||(u=t.isString(u)?{key:u}:t.clone(u),u.key||(u.key=f),this.__kb.vm_keys[f]=!0,this.__kb.model_keys[u.key]=!0,this[f]=this.__kb.view_model[f]=n.observable(i,t.defaults(u,e),this))},r}(),n.viewModel=function(t,i,r){return new n.ViewModel(t,i,r)},nt=0,d=-1,g=1,n.compare=function(n,i){return t.isString(n)?n.localeCompare(""+i):t.isString(i)?i.localeCompare(""+n):n===i?nt:n<i?d:g},n.CollectionObservable=function(){function f(f,e){var h,o,s=this;return!f||f instanceof n.Collection||u(this,"not a collection"),e||(e={}),o=n.utils.wrappedObservable(this,i.observableArray([])),o.__kb_is_co=!0,this.in_edit=0,this.__kb||(this.__kb={}),this.__kb._onCollectionChange=t.bind(this._onCollectionChange,this),e=p(e),this._comparator=e.sort_attribute?i.observable(this._attributeComparator(e.sort_attribute)):i.observable(e.comparator),this._filters=e.filters?i.observableArray(t.isArray(e.filters)?e.filters:e.filters?[e.filters]:void 0):i.observableArray([]),h=this.create_options={store:n.Store.useOptionsOrCreate(e,f,o)},this.path=e.path,h.factory=n.utils.wrappedFactory(o,this._shareOrCreateFactory(e)),h.path=n.utils.pathJoin(e.path,"models"),h.creator=h.factory.creatorForPath(null,h.path),h.creator&&(this.models_only=h.creator.models_only),o.destroy=t.bind(this.destroy,this),o.shareOptions=t.bind(this.shareOptions,this),o.filters=t.bind(this.filters,this),o.comparator=t.bind(this.comparator,this),o.sortAttribute=t.bind(this.sortAttribute,this),o.viewModelByModel=t.bind(this.viewModelByModel,this),o.hasViewModels=t.bind(this.hasViewModels,this),this._collection=i.observable(f),o.collection=this.collection=i.dependentObservable({read:function(){return s._collection()},write:function(n){var t;if((t=s._collection())!==n)return t&&t.unbind("all",s.__kb._onCollectionChange),n&&n.bind("all",s.__kb._onCollectionChange),s._collection(n)}}),f&&f.bind("all",this.__kb._onCollectionChange),this._mapper=i.dependentObservable(function(){var h,f,l,u,i,c,e,a;if(h=s._comparator(),u=s._filters(),u)for(e=0,a=u.length;e<a;e++)l=u[e],r(l);if(f=s._collection(),!s.in_edit)return o=n.utils.wrappedObservable(s),f&&(i=f.models),i&&f.models.length!==0?(u.length&&(i=t.filter(i,function(n){return!s._modelIsFiltered(n)})),c=h?t.map(i,function(n){return s._createViewModel(n)}).sort(h):s.models_only?u.length?i:i.slice():t.map(i,function(n){return s._createViewModel(n)})):c=[],s.in_edit++,o(c),s.in_edit--}),o.subscribe(t.bind(this._onObservableArrayChange,this)),n.statistics&&n.statistics.register("CollectionObservable",this),o}return f.extend=n.extend,f.prototype.destroy=function(){var i,r,t;return t=n.utils.wrappedObservable(this),r=this._collection(),r&&(r.unbind("all",this.__kb._onCollectionChange),i=t(),i.splice(0,i.length)),this.collection.dispose(),this._collection=t.collection=this.collection=null,this._mapper.dispose(),this._mapper=null,n.release(this._filters),this._filters=null,this._comparator(null),this._comparator=null,this.create_options=null,t.collection=null,n.utils.wrappedDestroy(this),!n.statistics||n.statistics.unregister("CollectionObservable",this)},f.prototype.shareOptions=function(){var t;return t=n.utils.wrappedObservable(this),{store:n.utils.wrappedStore(t),factory:n.utils.wrappedFactory(t)}},f.prototype.filters=function(n){return n?this._filters(t.isArray(n)?n:[n]):this._filters([])},f.prototype.comparator=function(n){return this._comparator(n)},f.prototype.sortAttribute=function(n){return this._comparator(n?this._attributeComparator(n):null)},f.prototype.viewModelByModel=function(i){var r;return this.models_only?null:(r=i.hasOwnProperty(i.idAttribute)?i.idAttribute:"cid",t.find(n.utils.wrappedObservable(this)(),function(n){var t;return(n!=null?(t=n.__kb)!=null?t.object:void 0:void 0)?n.__kb.object[r]===i[r]:!1}))},f.prototype.hasViewModels=function(){return!this.models_only},f.prototype._shareOrCreateFactory=function(t){var r,f,u,i;return(r=n.utils.pathJoin(t.path,"models"),u=t.factories,(i=t.factory)&&(f=i.creatorForPath(null,r))&&(!u||u.models===f)&&(!u||i.hasPathMappings(u,t.path)))?i:(i=new n.Factory(t.factory),u&&i.addPathMappings(u,t.path),i.creatorForPath(null,r)||(t.hasOwnProperty("models_only")?t.models_only?i.addPathMapping(r,{models_only:!0}):i.addPathMapping(r,n.ViewModel):t.view_model?i.addPathMapping(r,t.view_model):t.create?i.addPathMapping(r,{create:t.create}):i.addPathMapping(r,n.ViewModel)),i)},f.prototype._onCollectionChange=function(t,i){var e,f,r,u;if(!this.in_edit)switch(t){case"reset":case"resort":this._collection.notifySubscribers(this._collection());break;case"new":case"add":if(this._modelIsFiltered(i))return;if(r=n.utils.wrappedObservable(this),e=this._collection(),u=this.viewModelByModel(i))return;this.in_edit++,u=this._createViewModel(i),(f=this._comparator())?(r().push(u),r.sort(f)):r.splice(e.indexOf(i),0,u),this.in_edit--;break;case"remove":case"destroy":this._onModelRemove(i);break;case"change":this._modelIsFiltered(i)?this._onModelRemove(i):(u=this.models_only?i:this.viewModelByModel(i),u?(f=this._comparator())&&(r=n.utils.wrappedObservable(this),this.in_edit++,r.sort(f),this.in_edit--):this._onCollectionChange("add",i))}},f.prototype._onModelRemove=function(t){var r,i;if(i=this.models_only?t:this.viewModelByModel(t),i)return r=n.utils.wrappedObservable(this),this.in_edit++,r.remove(i),this.in_edit--},f.prototype._onObservableArrayChange=function(i){var e,o,s,r,l,h,f,c,a,v=this;if(!this.in_edit&&((!this.models_only||i.length&&!n.utils.hasModelSignature(i[0]))&&(this.models_only||i.length&&(!t.isObject(i[0])||n.utils.hasModelSignature(i[0])))&&u(this,"incorrect type passed"),l=n.utils.wrappedObservable(this),e=this._collection(),o=this._filters().length,e)){if(f=i,this.models_only)o&&(r=t.filter(i,function(n){return!v._modelIsFiltered(n)}));else for(o&&(f=[]),r=[],c=0,a=i.length;c<a;c++){if(h=i[c],s=n.utils.wrappedObject(h),o){if(this._modelIsFiltered(s))continue;f.push(h)}this.create_options.store.findOrReplace(s,this.create_options.creator,h),r.push(s)}this.in_edit++,i.length===f.length||l(f),t.isEqual(e.models,r)||e.reset(r),this.in_edit--}},f.prototype._attributeComparator=function(t){var i;return i=function(i,u){var f;return f=r(t),n.compare(i.get(f),u.get(f))},this.models_only?i:function(t,r){return i(n.utils.wrappedModel(t),n.utils.wrappedModel(r))}},f.prototype._createViewModel=function(n){return this.models_only?n:this.create_options.store.findOrCreate(n,this.create_options)},f.prototype._modelIsFiltered=function(n){var t,u,i,f;for(u=this._filters(),i=0,f=u.length;i<f;i++)if(t=u[i],t=r(t),typeof t=="function"&&t(n)||n&&n.id===t)return!0;return!1},f}(),n.collectionObservable=function(t,i){return new n.CollectionObservable(t,i)},n.RECUSIVE_AUTO_INJECT=!1,i.bindingHandlers.inject={init:function(t,i,u,f){return n.Inject.inject(r(i()),f,t,i,u)}},n.Inject=function(){function r(){}return r.inject=function(r,u,f,e,o,s){var h,c,l;return h=function(i){var h,c,r;if(t.isFunction(i))u=new i(u,f,e,o),n.releaseOnNodeRemove(u,f);else{i.view_model&&(u=new i.view_model(u,f,e,o),n.releaseOnNodeRemove(u,f));for(h in i)(r=i[h],h!=="view_model")&&(h==="create"?r(u,f,e,o):t.isObject(r)&&!t.isFunction(r)?(c=s||r&&r.create?{}:u,u[h]=n.Inject.inject(r,c,f,e,o,!0)):u[h]=r)}return u},s?h(r):(c=(l=i.dependentObservable(function(){return h(r)}))(),l.dispose(),c)},r.injectViewModels=function(i){var h,r,c,f,e,l,u,o,s,a;for(o=[],l=function(n){var u,f,i,e,r;for(n.__kb_injected||n.attributes&&(u=t.find(n.attributes,function(n){return n.name==="kb-inject"}))&&(n.__kb_injected=!0,o.push({el:n,view_model:{},binding:u.value})),r=n.childNodes,i=0,e=r.length;i<e;i++)f=r[i],l(f)},l(i||document),s=0,a=o.length;s<a;s++)r=o[s],(e=r.binding)&&(e.search(/[:]/)<0||(e="{"+e+"}"),f=new Function("","return ( "+e+" )")(),f||(f={}),f.options&&(u=f.options,delete f.options),u||(u={}),r.view_model=n.Inject.inject(f,r.view_model,r.el,null,null,!0),h=r.view_model.afterBinding||u.afterBinding,c=r.view_model.beforeBinding||u.beforeBinding),c&&c(r.view_model,r.el,u),n.applyBindings(r.view_model,r.el,u),h&&h(r.view_model,r.el,u);return o},r}(),et=i.applyBindings,i.applyBindings=function(t,i){var r;return r=n.RECUSIVE_AUTO_INJECT?n.injectViewModels(i):[],r.length?void 0:et.apply(this,arguments)},n.injectViewModels=n.Inject.injectViewModels,this.$?this.$(function(){return n.injectViewModels()}):(ut=function(){return document.readyState!=="complete"?setTimeout(ut,0):n.injectViewModels()})(),n.DefaultObservable=function(){function u(u,f){var e,o=this;return this.dv=f,e=n.utils.wrappedObservable(this,i.dependentObservable({read:function(){var n;return(n=r(u()))?n:r(o.dv)},write:function(n){return u(n)}})),e.destroy=t.bind(this.destroy,this),e.setToDefault=t.bind(this.setToDefault,this),e}return u.prototype.destroy=function(){return n.utils.wrappedDestroy(this)},u.prototype.setToDefault=function(){return n.utils.wrappedObservable(this)(this.dv)},u}(),n.defaultObservable=function(t,i){return new n.DefaultObservable(t,i)},n.Observable.prototype.setToDefault=function(){var n;(n=this.__kb_value)!=null&&typeof n.setToDefault=="function"&&n.setToDefault()},n.ViewModel.prototype.setToDefault=function(){var t,n;for(t in this.__kb.vm_keys)(n=this[t])!=null&&typeof n.setToDefault=="function"&&n.setToDefault()},n.utils.setToDefault=function(n){var u,r;if(n){if(i.isObservable(n))typeof n.setToDefault=="function"&&n.setToDefault();else if(t.isObject(n))for(u in n)r=n[u],r&&(i.isObservable(r)||typeof r!="function")&&(u[0]!=="_"||u.search("__kb"))&&this.setToDefault(r);return n}},v=Array.prototype.slice,n.toFormattedString=function(n){var o,e,t,i,u,f;u=n.slice(),e=v.call(arguments,1);for(t in e)for(o=e[t],f=r(o),f||(f=""),i=n.indexOf("{"+t+"}");i>=0;)u=u.replace("{"+t+"}",f),i=n.indexOf("{"+t+"}",i+1);return u},n.parseFormattedString=function(n,i){var h,o,r,c,f,l,u,s,p,e,a,v,y;for(e=i.slice(),r=0,l=0,s={};e.search("\\{"+r+"\\}")>=0;){for(u=i.indexOf("{"+r+"}");u>=0;)e=e.replace("{"+r+"}","(.*)"),s[u]=r,l++,u=i.indexOf("{"+r+"}",u+1);r++}if(h=r,p=new RegExp(e),f=p.exec(n),f&&f.shift(),!f||f.length!==l){for(a=[];h-->0;)a.push("");return a}y=t.sortBy(t.keys(s),function(n){return parseInt(n,10)}),o={};for(c in y)(u=y[c],r=s[u],o.hasOwnProperty(r))||(o[r]=c);for(v=[],r=0;r<h;)v.push(f[o[r]]),r++;return v},n.FormattedObservable=function(){function u(u,f){var e;return t.isArray(f)?(u=u,e=f):e=v.call(arguments,1),n.utils.wrappedObservable(this,i.dependentObservable({read:function(){var i,t,o;for(f=[r(u)],t=0,o=e.length;t<o;t++)i=e[t],f.push(r(i));return n.toFormattedString.apply(null,f)},write:function(t){var i,f,o;for(f=n.parseFormattedString(t,r(u)),o=Math.min(e.length,f.length),i=0;i<o;)e[i](f[i]),i++}}))}return u.prototype.destroy=function(){return n.utils.wrappedDestroy(this)},u}(),n.formattedObservable=function(t){return new n.FormattedObservable(t,v.call(arguments,1))},n.LocalizedObservable=function(){function f(f,o,s){var c,h=this;return this.value=f,this.vm=s,o||(o={}),this.vm||(this.vm={}),this.read||e(this,"read"),n.locale_manager||e(this,"kb.locale_manager"),this.__kb||(this.__kb={}),this.__kb._onLocaleChange=t.bind(this._onLocaleChange,this),this.__kb._onChange=o.onChange,this.value&&(f=r(this.value)),this.vo=i.observable(f?this.read(f,null):null),c=n.utils.wrappedObservable(this,i.dependentObservable({read:function(){return h.value&&r(h.value),h.vo(),h.read(r(h.value))},write:function(n){return h.write||u(h,"writing to read-only"),h.write(n,r(h.value)),h.vo(n),h.__kb._onChange?h.__kb._onChange(n):void 0},owner:this.vm})),c.destroy=t.bind(this.destroy,this),c.observedValue=t.bind(this.observedValue,this),c.resetToCurrent=t.bind(this.resetToCurrent,this),n.locale_manager.bind("change",this.__kb._onLocaleChange),o.hasOwnProperty("default")&&(c=n.DefaultObservable&&i.defaultObservable(c,o["default"])),c}return f.extend=n.extend,f.prototype.destroy=function(){return n.locale_manager.unbind("change",this.__kb._onLocaleChange),this.vm=null,n.utils.wrappedDestroy(this)},f.prototype.resetToCurrent=function(){var t,i;if(i=n.utils.wrappedObservable(this),t=this.value?this.read(r(this.value)):null,i()!==t)return i(t)},f.prototype.observedValue=function(n){if(arguments.length===0)return this.value;this.value=n,this._onLocaleChange()},f.prototype._onLocaleChange=function(){var n;return n=this.read(r(this.value)),this.vo(n),this.__kb._onChange?this.__kb._onChange(n):void 0},f}(),n.localizedObservable=function(t,i,r){return new n.LocalizedObservable(t,i,r)},n.locale_manager=void 0,n.TriggeredObservable=function(){function r(r,u){var f,o=this;return this.event_selector=u,r||e(this,"emitter"),this.event_selector||e(this,"event_selector"),this.vo=i.observable(),f=n.utils.wrappedObservable(this,i.dependentObservable(function(){return o.vo()})),f.destroy=t.bind(this.destroy,this),n.utils.wrappedEventWatcher(this,new n.EventWatcher(r,this,{emitter:t.bind(this.emitter,this),update:t.bind(this.update,this),event_selector:this.event_selector})),f}return r.prototype.destroy=function(){return n.utils.wrappedDestroy(this)},r.prototype.emitter=function(n){return arguments.length===0||this.ee===n?this.ee:(this.ee=n)?this.update():void 0},r.prototype.update=function(){if(this.ee)return this.vo()!==this.ee?this.vo(this.ee):this.vo.valueHasMutated()},r}(),n.triggeredObservable=function(t,i){return new n.TriggeredObservable(t,i)},y=function(n){return n=r(n),typeof n=="function"?n.apply(null,Array.prototype.slice.call(arguments,1)):n},n.Validation=function(){function n(){}return n}(),n.valueValidator=function(n,u,f){return f==null&&(f={}),(!f||typeof f=="function")&&(f={}),i.dependentObservable(function(){var c,l,s,e,h,o,i,a;i={$error_count:0},l=r(n),"disable"in f&&(s=y(f.disable)),"enable"in f&&(s=!y(f.enable)),o=f.priorities||[],t.isArray(o)||(o=[o]),c=o.length+1;for(e in u)a=u[e],i[e]=!s&&y(a,l),i[e]&&(i.$error_count++,(h=t.indexOf(o,e)>=0)||(h=o.length),i.$active_error&&h<c?(i.$active_error=e,c=h):i.$active_error||(i.$active_error=e,c=h));return i.$enabled=!s,i.$disable=!!s,i.$valid=i.$error_count===0,i})},n.inputValidator=function(i,r,u){var o,e,c,s,f,l,a,y,h,v;if((u==null&&(u={}),(!u||typeof u=="function")&&(u={}),h=n.valid,o=$(r),(s=o.attr("name"))&&!t.isString(s)&&(s=null),!(e=o.attr("data-bind")))||(f=new Function("sc","with(sc[0]) { return { "+e+" } }")([i]),!(f&&f.value)))return null;if(f.validation_options&&(t.defaults(f.validation_options,u),u=f.validation_options),e={},h[a=o.attr("type")]&&(e[a]=h[a]),o.attr("required")&&(e.required=h.required),f.validations){v=f.validations;for(c in v)y=v[c],e[c]=y}return l=n.valueValidator(f.value,e,u),(s||u.no_attach)&&(i["$"+s]=l),l},n.formValidator=function(r,u){var c,y,o,a,p,w,f,h,e,s,l,b,v;for(f={},s=[],c=$(u),(o=c.attr("name"))&&!t.isString(o)&&(o=null),(y=c.attr("data-bind"))&&(w=new Function("sc","with(sc[0]) { return { "+y+" } }")([r]),h=w.validation_options),h||(h={}),h.no_attach=!!o,v=c.find("input"),l=0,b=v.length;l<b;l++)(a=v[l],p=$(a).attr("name"))&&(e=n.inputValidator(r,a,h),e&&s.push(f[p]=e));return f.$error_count=i.dependentObservable(function(){var t,n,i;for(t=0,n=0,i=s.length;n<i;n++)e=s[n],t+=e().$error_count;return t}),f.$valid=i.dependentObservable(function(){return f.$error_count()===0}),f.$enabled=i.dependentObservable(function(){var t,n,i;for(t=!0,n=0,i=s.length;n<i;n++)e=s[n],t&=e().$enabled;return t}),f.$disabled=i.dependentObservable(function(){return!f.$enabled()}),o&&(r["$"+o]=f),f},rt=/^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/,tt=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}$/,it=/^\s*(\-|\+)?(\d+|(\d*(\.\d*)))\s*$/,n.valid={required:function(n){return!n},url:function(n){return!rt.test(n)},email:function(n){return!tt.test(n)},number:function(n){return!it.test(n)}},n.hasChangedFn=function(n){var u,i;return i=null,u=null,function(){var f;return i!==(f=r(n))?(i=f,u=i?i.toJSON():null,!1):(i&&u)?!t.isEqual(i.toJSON(),u):!1}},n.minLengthFn=function(n){return function(t){return!t||t.length<n}},n.uniqueValueFn=function(n,i,u){return function(f){var e,o,s,h=this;return(s=r(n),o=r(i),e=r(u),!(s&&o&&e))?!1:!!t.find(e.models,function(n){return n!==s&&n.get(o)===f})}},n.untilTrueFn=function(n,t,u){var f;return f=!1,u&&i.isObservable(u)&&u.subscribe(function(){return f=!1}),function(i){var u,e;return(u=r(t))?(f|=!!(e=u(r(i))),f?e:r(n)):r(n)}},n.untilFalseFn=function(n,t,u){var f;return f=!1,u&&i.isObservable(u)&&u.subscribe(function(){return f=!1}),function(i){var u,e;return(u=r(t))?(f|=!(e=u(r(i))),f?e:r(n)):r(n)}},n})}).call(this);
//@ sourceMappingURL=knockback.min.js.map